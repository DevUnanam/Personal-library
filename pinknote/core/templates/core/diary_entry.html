{% extends "core/base.html" %}

{% block title %}{% if entry %}Edit Entry{% else %}New Entry{% endif %} - PinkNote{% endblock %}

{% block content %}
<div class="card p-8 max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-3xl font-bold">{% if entry %}Edit Entry{% else %}New Entry{% endif %}</h2>
        <a href="{% url 'dashboard' %}" class="btn-secondary">‚Üê Back to Dashboard</a>
    </div>

    <form id="entryForm">
        {% csrf_token %}
        <input type="hidden" id="entryId" value="{% if entry %}{{ entry.id }}{% endif %}">

        <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">Date</label>
            <input type="date" id="entryDate" required class="input-field"
                   value="{% if entry %}{{ entry.date|date:'Y-m-d' }}{% endif %}">
        </div>

        <div class="mb-4">
            <label class="block text-gray-700 font-semibold mb-2">Title</label>
            <input type="text" id="entryTitle" required class="input-field"
                   placeholder="What's on your mind today?"
                   value="{% if entry %}{{ entry.title }}{% endif %}">
        </div>

        <div class="mb-6">
            <label class="block text-gray-700 font-semibold mb-2">Entry</label>
            <div id="editor" style="height: 400px; background: white; border-radius: 12px;"></div>
        </div>

        <div class="flex gap-4">
            <button type="submit" class="btn-primary flex-1">üíæ Save Entry</button>
            {% if entry %}
            <button type="button" id="deleteBtn" class="btn-secondary">üóëÔ∏è Delete</button>
            {% endif %}
        </div>

        <p id="saveStatus" class="mt-4 text-center text-sm text-gray-600"></p>
    </form>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Initialize Quill editor
    const quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: 'Write your thoughts here...',
        modules: {
            toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['blockquote', 'code-block'],
                ['link'],
                ['clean']
            ]
        }
    });

    {% if entry %}
    // Load existing content
    quill.root.innerHTML = {{ entry.body|safe|escapejs|safe }};
    {% endif %}

    // Check for date parameter in URL
    const urlParams = new URLSearchParams(window.location.search);
    const dateParam = urlParams.get('date');
    if (dateParam && !document.getElementById('entryId').value) {
        document.getElementById('entryDate').value = dateParam;
        // Load entry for this date if exists
        loadEntryByDate(dateParam);
    }

    // Auto-save functionality
    let saveTimeout;
    let lastSaved = null;

    quill.on('text-change', function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            autoSave();
        }, 2000);
    });

    document.getElementById('entryTitle').addEventListener('input', function() {
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => {
            autoSave();
        }, 2000);
    });

    async function autoSave() {
        const title = document.getElementById('entryTitle').value.trim();
        const date = document.getElementById('entryDate').value;
        const body = quill.root.innerHTML;

        if (!title || !date) return;

        const saveStatus = document.getElementById('saveStatus');
        saveStatus.textContent = 'Saving...';

        try {
            await saveEntry(title, date, body);
            lastSaved = new Date();
            saveStatus.textContent = '‚úì Auto-saved at ' + lastSaved.toLocaleTimeString();
            saveStatus.classList.add('text-green-600');

            setTimeout(() => {
                saveStatus.textContent = '';
                saveStatus.classList.remove('text-green-600');
            }, 3000);
        } catch (err) {
            saveStatus.textContent = 'Auto-save failed';
            saveStatus.classList.add('text-red-600');
        }
    }

    // Form submission
    document.getElementById('entryForm').addEventListener('submit', async function(e) {
        e.preventDefault();

        const title = document.getElementById('entryTitle').value.trim();
        const date = document.getElementById('entryDate').value;
        const body = quill.root.innerHTML;

        if (!title || !date) {
            alert('Please fill in all fields');
            return;
        }

        const saveStatus = document.getElementById('saveStatus');
        saveStatus.textContent = 'Saving...';

        try {
            await saveEntry(title, date, body);
            saveStatus.textContent = '‚úì Entry saved successfully!';
            saveStatus.classList.add('text-green-600');

            setTimeout(() => {
                window.location.href = '/dashboard/';
            }, 1000);
        } catch (err) {
            saveStatus.textContent = 'Error saving entry';
            saveStatus.classList.add('text-red-600');
            alert('Error saving entry: ' + err.message);
        }
    });

    async function saveEntry(title, date, body) {
        const entryId = document.getElementById('entryId').value;

        const response = await fetch('/api/diary/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify({
                id: entryId || null,
                title: title,
                date: date,
                body: body
            })
        });

        const data = await response.json();

        if (data.success) {
            // Update entry ID if it was a new entry
            if (!entryId) {
                document.getElementById('entryId').value = data.id;
            }
            return data;
        } else {
            throw new Error(data.error || 'Save failed');
        }
    }

    async function loadEntryByDate(date) {
        try {
            const response = await fetch(`/api/diary/by-date/?date=${date}`);
            const data = await response.json();

            if (data.success && data.entry) {
                document.getElementById('entryId').value = data.entry.id;
                document.getElementById('entryTitle').value = data.entry.title;
                document.getElementById('entryDate').value = data.entry.date;
                quill.root.innerHTML = data.entry.body;
            }
        } catch (err) {
            console.error('Error loading entry:', err);
        }
    }

    // Delete functionality
    {% if entry %}
    document.getElementById('deleteBtn').addEventListener('click', async function() {
        if (!confirm('Are you sure you want to delete this entry?')) return;

        try {
            const response = await fetch('/api/diary/delete/{{ entry.id }}/', {
                method: 'POST',
                headers: {
                    'X-CSRFToken': csrftoken
                }
            });

            const data = await response.json();

            if (data.success) {
                alert('Entry deleted successfully');
                window.location.href = '/dashboard/';
            } else {
                alert('Error deleting entry');
            }
        } catch (err) {
            alert('Error: ' + err.message);
        }
    });
    {% endif %}
</script>
{% endblock %}
