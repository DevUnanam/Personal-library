{% extends "core/base.html" %}
{% load static %}

{% block title %}Login - PinkNote{% endblock %}

{% block extra_css %}
<style>
    /* Page-specific background using static image */
    /* Two-column layout: left image, right form */
    .auth-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        min-height: 80vh;
        align-items: center;
    }

    .auth-image {
        width: 100%;
        height: 100%;
        min-height: 420px;
        background-image: url("{% static 'images/background.png' %}");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        position: relative;
        overflow: hidden;
    }

    .auth-image::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(138,79,255,0.25), rgba(255,111,181,0.25));
        mix-blend-mode: overlay;
    }

    .glass-card {
        background: rgba(255,255,255,0.6);
        backdrop-filter: blur(10px) saturate(120%);
        -webkit-backdrop-filter: blur(10px) saturate(120%);
        border: 1px solid rgba(255,255,255,0.6);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(138,79,255,0.08);
    }

    .glass-card, .glass-card * { position: relative; z-index: 2; }

    @media (max-width: 768px) {
        .auth-grid { grid-template-columns: 1fr; padding: 1rem; }
        .auth-image { display: none; }
        .glass-card { padding: 1.25rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center">
    <div class="w-full max-w-6xl auth-grid">
        <div class="auth-image" aria-hidden="true"></div>

        <div class="glass-card mx-auto w-full max-w-md">
            <h2 class="text-3xl text-center mb-6">Welcome Back</h2>

            <div class="mb-6 flex gap-2">
                <button type="button" id="passwordLoginTab" class="btn-primary flex-1">Password Login</button>
                <button type="button" id="faceLoginTab" class="btn-secondary flex-1">Face Login</button>
            </div>

            <!-- Password Login Form -->
            <form method="POST" id="passwordLoginForm">
                {% csrf_token %}

                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Username</label>
                    <input type="text" name="username" required class="input-field" placeholder="Your username">
                </div>

                <div class="mb-6">
                    <label class="block text-gray-700 font-semibold mb-2">Password</label>
                    <input type="password" name="password" required class="input-field" placeholder="Your password">
                </div>

                <button type="submit" class="btn-primary w-full">Login</button>
            </form>

            <!-- Face Login Form -->
            <div id="faceLoginForm" class="hidden">
                <div class="mb-4">
                    <label class="block text-gray-700 font-semibold mb-2">Username</label>
                    <input type="text" id="faceUsername" required class="input-field" placeholder="Your username">
                </div>

                <div class="text-center mb-4">
                    <video id="faceVideo" width="320" height="240" autoplay class="mx-auto rounded-lg mb-3"></video>
                    <button type="button" id="startFaceLogin" class="btn-primary">Verify Face</button>
                    <p id="faceLoginStatus" class="mt-2 text-sm text-gray-600"></p>
                </div>
            </div>

            <p class="text-center mt-6 text-gray-600">
                Don't have an account? <a href="{% url 'register' %}" class="text-pink-main font-semibold">Register</a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const passwordTab = document.getElementById('passwordLoginTab');
    const faceTab = document.getElementById('faceLoginTab');
    const passwordForm = document.getElementById('passwordLoginForm');
    const faceLoginDiv = document.getElementById('faceLoginForm');
    const video = document.getElementById('faceVideo');
    const startFaceLoginBtn = document.getElementById('startFaceLogin');
    const faceLoginStatus = document.getElementById('faceLoginStatus');
    let stream = null;

    passwordTab.addEventListener('click', function() {
        passwordForm.classList.remove('hidden');
        faceLoginDiv.classList.add('hidden');
        passwordTab.classList.remove('btn-secondary');
        passwordTab.classList.add('btn-primary');
        faceTab.classList.remove('btn-primary');
        faceTab.classList.add('btn-secondary');
        stopVideo();
    });

    faceTab.addEventListener('click', async function() {
        passwordForm.classList.add('hidden');
        faceLoginDiv.classList.remove('hidden');
        faceTab.classList.remove('btn-secondary');
        faceTab.classList.add('btn-primary');
        passwordTab.classList.remove('btn-primary');
        passwordTab.classList.add('btn-secondary');
        await startVideo();
    });

    async function startVideo() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            faceLoginStatus.textContent = 'Camera ready. Click Verify Face to login.';
        } catch (err) {
            faceLoginStatus.textContent = 'Error accessing camera: ' + err.message;
        }
    }

    function stopVideo() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    startFaceLoginBtn.addEventListener('click', async function() {
        const username = document.getElementById('faceUsername').value;

        if (!username) {
            faceLoginStatus.textContent = 'Please enter your username.';
            return;
        }

        faceLoginStatus.textContent = 'Loading face detection models...';

        try {
            // Load face-api models
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model');
            await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model');
            await faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model');

            faceLoginStatus.textContent = 'Detecting face...';

            const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptor();

            if (detections) {
                const descriptor = Array.from(detections.descriptor);
                faceLoginStatus.textContent = 'Verifying...';

                // Send to server
                const response = await fetch('/api/face-login/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrftoken
                    },
                    body: JSON.stringify({
                        username: username,
                        face_data: JSON.stringify(descriptor)
                    })
                });

                const data = await response.json();

                if (data.success) {
                    faceLoginStatus.textContent = 'âœ“ Login successful! Redirecting...';
                    faceLoginStatus.classList.add('text-green-600');
                    setTimeout(() => {
                        window.location.href = '/dashboard/';
                    }, 1000);
                } else {
                    faceLoginStatus.textContent = 'Face recognition failed. Please try again or use password login.';
                    faceLoginStatus.classList.add('text-red-600');
                }
            } else {
                faceLoginStatus.textContent = 'No face detected. Please try again.';
                faceLoginStatus.classList.add('text-red-600');
            }
        } catch (err) {
            faceLoginStatus.textContent = 'Error: ' + err.message;
            faceLoginStatus.classList.add('text-red-600');
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', stopVideo);
</script>
{% endblock %}
