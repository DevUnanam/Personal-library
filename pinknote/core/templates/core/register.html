{% extends "core/base.html" %}
{% load static %}

{% block title %}Register - PinkNote{% endblock %}

{% block extra_css %}
<style>
    /* Page-specific background using static image */
    /* Two-column layout: left image, right form */
    .auth-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 2rem;
        min-height: 80vh;
        align-items: center;
    }

    .auth-image {
        width: 100%;
        height: 100%;
        min-height: 420px;
        background-image: url("{% static 'images/background.png' %}");
        background-size: cover;
        background-position: center;
        background-repeat: no-repeat;
        border-radius: 20px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.12);
        position: relative;
        overflow: hidden;
    }

    /* Decorative gradient overlay on image side */
    .auth-image::after {
        content: '';
        position: absolute;
        inset: 0;
        background: linear-gradient(180deg, rgba(138,79,255,0.25), rgba(255,111,181,0.25));
        mix-blend-mode: overlay;
    }

    /* Glass-morphic card for forms */
    .glass-card {
        background: rgba(255,255,255,0.6);
        backdrop-filter: blur(10px) saturate(120%);
        -webkit-backdrop-filter: blur(10px) saturate(120%);
        border: 1px solid rgba(255,255,255,0.6);
        border-radius: 16px;
        padding: 2rem;
        box-shadow: 0 8px 32px rgba(138,79,255,0.08);
    }

    /* Keep video and card elements above overlays */
    .glass-card, .glass-card * { position: relative; z-index: 2; }

    /* Responsive: stack on small screens */
    @media (max-width: 768px) {
        .auth-grid { grid-template-columns: 1fr; padding: 1rem; }
        .auth-image { display: none; }
        .glass-card { padding: 1.25rem; }
    }
</style>
{% endblock %}

{% block content %}
<div class="min-h-screen flex items-center justify-center">
    <div class="w-full max-w-6xl auth-grid">
        <div class="auth-image" aria-hidden="true"></div>

        <div class="glass-card mx-auto w-full max-w-md">
            <h2 class="text-3xl text-center mb-6">Create Your Account</h2>

            <form method="POST" id="registerForm">
            {% csrf_token %}

            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Username</label>
                <input type="text" name="username" required class="input-field" placeholder="Choose a username">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Email</label>
                <input type="email" name="email" required class="input-field" placeholder="your@email.com">
            </div>

            <div class="mb-4">
                <label class="block text-gray-700 font-semibold mb-2">Password</label>
                <input type="password" name="password" required class="input-field" placeholder="Choose a secure password">
            </div>

            <div class="mb-6">
                <label class="flex items-center">
                    <input type="checkbox" id="enrollFace" class="mr-2">
                    <span class="text-gray-700">Enable Face Recognition Login (Optional)</span>
                </label>
            </div>

            <div id="faceEnrollSection" class="mb-6 hidden">
                <div class="text-center">
                    <video id="video" width="320" height="240" autoplay class="mx-auto rounded-lg mb-3"></video>
                    <button type="button" id="captureFaceBtn" class="btn-secondary">Capture Face</button>
                    <p id="faceStatus" class="mt-2 text-sm text-gray-600"></p>
                </div>
                <input type="hidden" name="face_data" id="faceData">
            </div>

            <button type="submit" class="btn-primary w-full">Create Account</button>
            </form>

            <p class="text-center mt-6 text-gray-600">
                Already have an account? <a href="{% url 'login' %}" class="text-pink-main font-semibold">Login</a>
            </p>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const enrollCheckbox = document.getElementById('enrollFace');
    const faceSection = document.getElementById('faceEnrollSection');
    const video = document.getElementById('video');
    const captureBtn = document.getElementById('captureFaceBtn');
    const faceStatus = document.getElementById('faceStatus');
    const faceDataInput = document.getElementById('faceData');
    let stream = null;

    enrollCheckbox.addEventListener('change', async function() {
        if (this.checked) {
            faceSection.classList.remove('hidden');
            await startVideo();
        } else {
            faceSection.classList.add('hidden');
            stopVideo();
        }
    });

    async function startVideo() {
        try {
            stream = await navigator.mediaDevices.getUserMedia({ video: {} });
            video.srcObject = stream;
            faceStatus.textContent = 'Camera ready. Position your face and click Capture Face.';
        } catch (err) {
            faceStatus.textContent = 'Error accessing camera: ' + err.message;
        }
    }

    function stopVideo() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    captureBtn.addEventListener('click', async function() {
        faceStatus.textContent = 'Loading face detection models...';

        try {
            // Load face-api models
            await faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model');
            await faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model');
            await faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api@1.7.12/model');

            faceStatus.textContent = 'Detecting face...';

            const detections = await faceapi.detectSingleFace(video, new faceapi.TinyFaceDetectorOptions())
                .withFaceLandmarks()
                .withFaceDescriptor();

            if (detections) {
                const descriptor = Array.from(detections.descriptor);
                faceDataInput.value = JSON.stringify(descriptor);
                faceStatus.textContent = '✓ Face captured successfully!';
                faceStatus.classList.add('text-green-600');
                captureBtn.textContent = 'Face Captured ✓';
                captureBtn.disabled = true;
            } else {
                faceStatus.textContent = 'No face detected. Please try again.';
                faceStatus.classList.add('text-red-600');
            }
        } catch (err) {
            faceStatus.textContent = 'Error: ' + err.message;
            faceStatus.classList.add('text-red-600');
        }
    });

    // Cleanup on page unload
    window.addEventListener('beforeunload', stopVideo);
</script>
{% endblock %}
